<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¶”ì²¨/í˜¸ëª… ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light" />
  <style>
    html, body { height: 100%; }
    /* ë¼ì´íŠ¸ ëª¨ë“œ ê°•ì œ ë° ê¸°ë³¸ í…ìŠ¤íŠ¸ ì»¬ëŸ¬ ë³´ì¥ */
    :root { color-scheme: light; }
    body { color: #111827; background-color: #f8fafc; }
    input, textarea, button, select { color: #111827; }
    table, th, td { color: #111827; }
    /* ìŠ¤í¬ë¡¤ ì˜ì—­ í…Œì´ë¸” ê³ ì • í—¤ë” */
    thead th { position: sticky; top: 0; background: #f3f4f6; z-index: 1; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-4 md:p-8">
  <div class="max-w-6xl mx-auto space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">ğŸ”¢ ì¶”ì²¨/í˜¸ëª… ê´€ë¦¬</h1>
      <div class="flex items-center gap-2">
        <button id="resetAll" class="px-3 py-2 rounded-xl bg-red-500 text-white shadow hover:opacity-90">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </header>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="bg-white shadow rounded-2xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">â• ë‹¨ì¼ ì¶”ê°€</h2>
        <div class="grid grid-cols-5 gap-2 items-end">
          <div class="col-span-3">
            <label class="text-sm text-gray-600">ëŒ€ìƒì ì´ë¦„</label>
            <input id="singleName" placeholder="ì˜ˆ) ê¹€ì² ìˆ˜" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div class="col-span-2">
            <label class="text-sm text-gray-600">ë²ˆí˜¸(ìˆ«ì)</label>
            <input id="singleNumber" inputmode="numeric" placeholder="ì˜ˆ) 12" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div class="col-span-5 flex justify-end">
            <button id="addSingle" class="px-4 py-2 rounded-xl bg-blue-600 text-white shadow hover:opacity-90">ì¶”ê°€</button>
          </div>
        </div>
      </div>

      <div class="bg-white shadow rounded-2xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">ğŸ“¥ ë²Œí¬ ì…ë ¥ (ì—¬ëŸ¬ ëª… í•œ ë²ˆì—)</h2>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">ëŒ€ìƒì (í•œ ì¤„ì— í•œ ëª…)</label>
            <textarea id="bulkNames" placeholder="ì˜ˆ)\nê¹€ì² ìˆ˜\nì´ì˜í¬\në°•ë¯¼ìˆ˜, 101  â† ì´ë ‡ê²Œ 'ì´ë¦„,ë²ˆí˜¸'ë¡œ ì¨ë„ ìë™ ì¸ì‹" class="w-full h-36 p-3 rounded-xl border resize-y"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600">ë²ˆí˜¸ ëª©ë¡ (ì¤„/ì‰¼í‘œ/ì„¸ë¯¸ì½œë¡  ê°€ëŠ¥)</label>
            <textarea id="bulkNumbers" placeholder="ì˜ˆ)\n1,2,3,4\në˜ëŠ”\n1\n2\n3\n4" class="w-full h-36 p-3 rounded-xl border resize-y"></textarea>
          </div>
        </div>
        <div class="flex justify-end">
          <button id="pairing" class="px-4 py-2 rounded-xl bg-emerald-600 text-white shadow hover:opacity-90">í˜ì–´ë§ ìƒì„±</button>
        </div>
        <p class="text-xs text-gray-500">* ì´ë¦„ ì¤„ì— <code>ì´ë¦„,ë²ˆí˜¸</code> ë˜ëŠ” <code>ì´ë¦„ ë²ˆí˜¸</code> í˜•íƒœê°€ ìˆìœ¼ë©´ ë²ˆí˜¸ ì¹¸ì´ ë¹„ì–´ë„ ìë™ ë§¤ì¹­í•©ë‹ˆë‹¤. ê·¸ ì™¸ëŠ” ì™¼ìª½ ì´ë¦„ìˆœê³¼ ì˜¤ë¥¸ìª½ ë²ˆí˜¸ìˆœìœ¼ë¡œ ê°™ì€ ìˆœì„œë¡œ ì§ì§€ì–´ì§‘ë‹ˆë‹¤.</p>
      </div>
    </section>

    <!-- ê²€ìƒ‰/ìš”ì•½ -->
    <section class="flex flex-wrap items-center gap-3">
      <div class="flex-1 min-w-[220px]">
        <input id="query" placeholder="ê²€ìƒ‰: ë²ˆí˜¸(ì •í™•íˆ) ë˜ëŠ” ì´ë¦„ í¬í•¨" class="w-full px-4 py-2 rounded-2xl border" />
      </div>
      <div id="summary" class="text-sm text-gray-600">ì´ 0ëª… Â· í˜¸ëª…ë¨ 0ëª…</div>
    </section>

    <!-- ì •ë ¬ í‘œì‹œ -->
    <section class="bg-white shadow rounded-2xl overflow-hidden">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h2 class="font-semibold">ğŸ“‹ í˜„ì¬ ëª©ë¡ (ë²ˆí˜¸ ì˜¤ë¦„ì°¨ìˆœ)</h2>
        <span class="text-sm text-gray-500">ì²´í¬í•˜ë©´ ëª©ë¡ì—ì„œ ì œê±°ë©ë‹ˆë‹¤.</span>
      </div>
      <div class="max-h-[55vh] overflow-auto">
        <table class="min-w-full">
          <thead class="bg-gray-100 text-left">
            <tr>
              <th class="p-3 w-16">í˜¸ëª…</th>
              <th class="p-3 w-28">ë²ˆí˜¸</th>
              <th class="p-3">ì´ë¦„</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
    </section>

    <!-- í˜¸ëª…ë¨ ì„¹ì…˜ -->
    <section class="bg-white shadow rounded-2xl overflow-hidden">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h2 class="font-semibold">âœ… í˜¸ëª…ë¨ (ì²´í¬ë¡œ ì œê±°ëœ í•­ëª©)</h2>
        <span class="text-sm text-gray-500">í´ë¦­í•˜ë©´ ë³µì›ë©ë‹ˆë‹¤.</span>
      </div>
      <div id="calledWrap" class="p-3 flex flex-wrap gap-2"></div>
    </section>

    <details class="bg-white shadow rounded-2xl p-4">
      <summary class="cursor-pointer font-semibold">ë„ì›€ë§</summary>
      <ul class="list-disc pl-6 text-sm text-gray-700 space-y-1 mt-2">
        <li>ë²Œí¬ ì…ë ¥ì—ì„œëŠ” ì™¼ìª½(ì´ë¦„)ê³¼ ì˜¤ë¥¸ìª½(ë²ˆí˜¸)ì„ ê°™ì€ ìˆœì„œë¡œ ë§¤ì¹­í•©ë‹ˆë‹¤.</li>
        <li>ì´ë¦„ ì¤„ì— <code>ì´ë¦„,ë²ˆí˜¸</code> ë˜ëŠ” <code>ì´ë¦„ ë²ˆí˜¸</code> í˜•íƒœê°€ ìˆìœ¼ë©´ ë²ˆí˜¸ ì¹¸ ì—†ì´ë„ ìë™ ì¸ì‹í•©ë‹ˆë‹¤.</li>
        <li>ì²´í¬í•˜ë©´ í•´ë‹¹ í•­ëª©ì´ ì¦‰ì‹œ ìœ„ ëª©ë¡ì—ì„œ ì œê±°ë˜ê³ , ì•„ë˜ <b>í˜¸ëª…ë¨</b> ì˜ì—­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. ë°°ì§€ë¥¼ í´ë¦­í•˜ë©´ ë‹¤ì‹œ ë³µì›ë©ë‹ˆë‹¤.</li>
        <li>ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤(ê°™ì€ ì»´í“¨í„°/ë¸Œë¼ìš°ì €ì—ì„œ ìœ ì§€).</li>
        <li>ì¤‘ë³µ ë²ˆí˜¸ê°€ ìˆì„ ê²½ìš°, ë®ì–´ì“°ê¸° ì—¬ë¶€ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      </ul>
    </details>
  </div>

 <script type="module">
  /* ===== Firebase SDK (CDN) ===== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ===== ë‹¹ì‹  ì½˜ì†”ì˜ SDK ì„¤ì •ê°’ìœ¼ë¡œ ë°”ê¿” ë„£ê¸° ===== */
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "pick-gift.firebaseapp.com",
    projectId: "pick-gift",
    storageBucket: "pick-gift.appspot.com",
    messagingSenderId: "372503045664",
    appId: "1:372503045664:web:b6d31074c9dee9a6dfffe45",
    measurementId: "G-Y5N46XNLH2"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ===== ë°©(ê³µìœ  ì„¸ì…˜) ID: URL ?room=ê°’ ì‚¬ìš© ===== */
  const url = new URL(location.href);
  const roomId = url.searchParams.get("room") || "default";
  const roomRef = doc(db, "rooms", roomId);

  /* ===== ê¸°ì¡´ ì½”ë“œì˜ ë³€ìˆ˜/DOM ì°¸ì¡° ê·¸ëŒ€ë¡œ ì‚¬ìš© ===== */
  const KEY = 'raffle_app_v1_html_cache';
  let entries = [];
  let called  = [];

  const singleName   = document.getElementById('singleName');
  const singleNumber = document.getElementById('singleNumber');
  const addSingle    = document.getElementById('addSingle');
  const bulkNames    = document.getElementById('bulkNames');
  const bulkNumbers  = document.getElementById('bulkNumbers');
  const pairing      = document.getElementById('pairing');
  const listBody     = document.getElementById('listBody');
  const calledWrap   = document.getElementById('calledWrap');
  const resetAll     = document.getElementById('resetAll');
  const query        = document.getElementById('query');
  const summary      = document.getElementById('summary');

  /* ===== ìœ í‹¸ ===== */
  function parseList(text){
    if (!text || !text.trim()) return [];
    return text.split(/\n|,|\t|;/g).map(s=>s.trim()).filter(Boolean);
  }
  function mergeUnique(base, adds){
    const map = new Map(base.map(e=>[e.number, e]));
    const dups = [];
    for (const a of adds){ if (map.has(a.number)) dups.push(a); }
    if (dups.length){
      const overwrite = confirm(
        `ì¤‘ë³µ ë²ˆí˜¸ê°€ ${dups.length}ê°œ ìˆìŠµë‹ˆë‹¤. ê°™ì€ ë²ˆí˜¸ëŠ” ë®ì–´ì“¸ê¹Œìš”?\n`+
        dups.map(d=>`#${d.number} â† ${d.name}`).join('\n')
      );
      if (!overwrite){
        for (const a of adds){ if (!map.has(a.number)) map.set(a.number, a); }
        return Array.from(map.values());
      }
    }
    for (const a of adds){ map.set(a.number, a); }
    return Array.from(map.values());
  }

  /* ===== ë Œë” ===== */
  function render(){
    summary.textContent = `ì´ ${entries.length}ëª… Â· í˜¸ëª…ë¨ ${called.length}ëª…`;
    const q = (query.value || '').trim();
    let list = [...entries].sort((a,b)=>a.number-b.number);
    if (q) {
      if (/^\d+$/.test(q)) list = list.filter(e=>e.number===Number(q));
      else list = list.filter(e=>e.name.includes(q));
    }
    listBody.innerHTML = '';
    if (list.length===0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.className = 'p-6 text-center text-gray-400';
      td.textContent = 'í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.';
      tr.appendChild(td); listBody.appendChild(tr);
    } else {
      for (const e of list){
        const tr = document.createElement('tr');
        tr.className = 'border-t hover:bg-gray-50';

        const tdCheck = document.createElement('td');
        tdCheck.className = 'p-3 align-middle';
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.title='í˜¸ëª… ì²˜ë¦¬';
        cb.addEventListener('change',()=> handleCall(e.number));
        tdCheck.appendChild(cb);

        const tdNum = document.createElement('td');
        tdNum.className = 'p-3 font-mono';
        tdNum.textContent = `#${e.number}`;

        const tdName = document.createElement('td');
        tdName.className = 'p-3';
        tdName.textContent = e.name;

        tr.appendChild(tdCheck); tr.appendChild(tdNum); tr.appendChild(tdName);
        listBody.appendChild(tr);
      }
    }
    calledWrap.innerHTML = '';
    if (called.length===0){
      const span = document.createElement('span');
      span.className = 'text-gray-400';
      span.textContent = 'ì•„ì§ ì—†ìŠµë‹ˆë‹¤.';
      calledWrap.appendChild(span);
    } else {
      for (const c of called){
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1 rounded-full border shadow-sm hover:bg-gray-50';
        btn.title = 'í´ë¦­í•˜ì—¬ ë³µì›';
        btn.textContent = `#${c.number} Â· ${c.name}`;
        btn.addEventListener('click',()=>restoreCalled(c.number));
        calledWrap.appendChild(btn);
      }
    }
  }

  /* ===== ë¡œì»¬ ìºì‹œ(ì˜¤í”„ë¼ì¸ ëŒ€ë¹„) ===== */
  function saveCache(){ localStorage.setItem(KEY, JSON.stringify({ entries, called })); }
  function loadCache(){
    try{
      const raw = localStorage.getItem(KEY);
      if (raw){ const p = JSON.parse(raw); entries = p.entries||[]; called = p.called||[]; }
    }catch(e){ console.error(e); }
  }

  /* ===== í´ë¼ìš°ë“œ ì €ì¥ ë””ë°”ìš´ìŠ¤ ===== */
  let applyingRemote = false;
  let saveTimer = null;
  function queueSave(){
    saveCache();
    if (applyingRemote) return;
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      try{
        await setDoc(roomRef, { entries, called, updatedAt: serverTimestamp() }, { merge: true });
      }catch(e){ console.error(e); }
    }, 200);
  }

  /* ===== ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ì›ë˜ ë¡œì§ ìœ ì§€, saveâ†’queueSaveë§Œ ë³€ê²½) ===== */
  function handlePairing(){
    const nameLines = (bulkNames.value||'').split(/\n/g).map(s=>s.trim()).filter(Boolean);
    let numbers = parseList(bulkNumbers.value).map(n=>Number(n));

    const autoPairs = [], remainNames = [];
    for (const line of nameLines){
      const m = line.match(/^(.*?)[,\s]+(-?\d+)$/);
      if (m) autoPairs.push({name:m[1].trim(), number:Number(m[2])});
      else remainNames.push(line);
    }
    const pairs = [...autoPairs];
    for (let i=0;i<remainNames.length;i++){
      const nm = remainNames[i]; const num = numbers[i];
      if (nm && (num===0 || !!num)) pairs.push({name:nm, number:Number(num)});
    }
    const invalid = pairs.filter(p=>!p.name || Number.isNaN(p.number));
    if (invalid.length){
      alert('ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ê°€ ë¹„ì–´ ìˆê±°ë‚˜ ìˆ«ìê°€ ì•„ë‹™ë‹ˆë‹¤.\në¬¸ì œ í•­ëª© ì˜ˆ: '+ invalid[0].name + ' / ' + invalid[0].number);
      return;
    }
    entries = mergeUnique(entries, pairs);
    bulkNames.value=''; bulkNumbers.value='';
    queueSave(); render();
  }

  function handleAddSingle(){
    const nm = (singleName.value||'').trim();
    const numStr = (singleNumber.value||'').replace(/[^-\d]/g,'');
    const num = Number(numStr);
    if (!nm || Number.isNaN(num)){ alert('ì´ë¦„ê³¼ ìˆ«ì ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    entries = mergeUnique(entries, [{ name: nm, number: num }]);
    singleName.value=''; singleNumber.value='';
    queueSave(); render();
  }

  function handleCall(num){
    const idx = entries.findIndex(e=>e.number===num);
    if (idx===-1) return;
    const target = entries[idx];
    entries.splice(idx,1);
    called.unshift({ ...target, ts: Date.now() });
    queueSave(); render();
  }

  function restoreCalled(num){
    const idx = called.findIndex(e=>e.number===num);
    if (idx===-1) return;
    const target = called[idx];
    called.splice(idx,1);
    entries = mergeUnique(entries, [{ name: target.name, number: target.number }]);
    queueSave(); render();
  }

  function doReset(){
    if (!confirm('ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (í˜¸ëª…ë¨ í¬í•¨)')) return;
    entries = []; called = [];
    queueSave(); render();
  }

  pairing.addEventListener('click', handlePairing);
  addSingle.addEventListener('click', handleAddSingle);
  resetAll.addEventListener('click', doReset);
  query.addEventListener('input', render);

  /* ===== ì‹œì‘: ìµëª… ë¡œê·¸ì¸ â†’ ì‹¤ì‹œê°„ êµ¬ë… â†’ ì´ˆê¸° ë Œë” ===== */
  onAuthStateChanged(auth, async (user)=>{
    if (!user){ await signInAnonymously(auth); return; }

    loadCache(); render(); // ì˜¤í”„ë¼ì¸ ìºì‹œ ë¨¼ì €

    onSnapshot(roomRef, async (snap)=>{
      if (!snap.exists()){
        await setDoc(roomRef, { entries, called, updatedAt: serverTimestamp() }, { merge: true });
        return;
      }
      const data = snap.data() || {};
      applyingRemote = true;
      try{
        entries = Array.isArray(data.entries) ? data.entries : [];
        called  = Array.isArray(data.called)  ? data.called  : [];
        saveCache(); render();
      } finally {
        applyingRemote = false;
      }
    });
  });

  console.log(`Shared room: ${roomId}  (ê°™ì€ URLì˜ ?room=${roomId} ë¡œ ì ‘ì†í•˜ë©´ í•¨ê»˜ ì‹¤ì‹œê°„ ê³µìœ )`);
</script>

</body>
</html>
